
*** Текущая реализация CommandACL :

Цель: минимизировать количество настроек Bacula и Webacula.

Настройка:
Необходим общий для Bacula Director и Webacula каталог.
В конфиге bacula-dir.conf:
@|"sh -c 'for f in /var/www/webacula/user-console.d/*-console.conf ; do echo @${f} ; done'"
Там же создать запрещающий .htaccess
  * Новое поле в таблице webacula_users - пароль к Director для bconsole 
    (для безопасности - НЕ может совпадать с паролем на логин юзера)
  * Новый параметр в .ini для хранения полного пути к /sbin/bacula-dir

Алгоритм:
Webacula тестирует доступность /var/www/webacula/user-console.d/ на запись.
При изменениях настроек роли (в админке) Webacula перезаписывает файл, содержащий конфигурацию для 
Director -> Console resource : 
    /var/www/webacula/user-console.d/<имя роли>-console.conf

Файл <имя роли>-console.conf создается для каждой роли, зарегистрированной в Webacula.
Причем <имя роли>-console.conf для каждой роли создается на основе данных по всем Bacula ACLs, хранящимся в БД Webacula.

После создания файл <имя роли>-console.conf тестируется с помощью 
    /sbin/bacula-dir -t -c bacula-dir-fake.conf
    где bacula-dir-fake.conf - типовой конфиг с подключенным вновь созданным <имя роли>-console.conf
    
После проверки <имя роли>-console.conf в Bacula Director посылается команда "reload" для вступления изменений в действие.  

При запуске любой команды Webacula создает во _временном_ каталоге (см. 'tmpdir' в config.ini) xxx-bconsole.conf
    где "xxx" - имя роли. 
Далее запускает для тестирования конфига 
    bconsole -t xxx-bconsole.conf
и если всё - ок, реально запускаем    
    bconsole -c xxx-bconsole.conf
и пусть Bacula сама применяет все свои ACLs.
После получения вывода от директора - удалить xxx-bconsole.conf из временного каталога.

При этом Webacula выступает в роли Web-interface конфигуратора для Bacula. 
Пока - с ограниченными (только Console resource) возможностями.






-------------------------------------------------------------------------------------------------------
Текущее состояние :

  * ClientACL
+  * StorageACL
+  * PoolACL
  * FileSetACL
  * WhereACL
  * ScheduleACL not used in Webacula, not implemented
  * CatalogACL  not used in Webacula, not implemented
    
-------------------------------------------------------------------------------------------------------

Ограничения на запуск команд в bconsole
        // do Bacula ACLs
        $command = 'list';
        if ( !$this->_bacula_acl->doOneBaculaAcl($command, 'name', 'command') ) {
            $this->view->msg = sprintf( $this->view->translate->_('You try to run Bacula Console with  command "%s".'), $command );
            echo $this->renderScript('bacula-access-denied.phtml');
            return;
        }
        
-------------------------------------------------------------------------------------------------------        

везде в скриптах вида, заменить обращения к объектам на массивы, т.к. возвращаться будет массив

-------------------------------------------------------------------------------------------------------
во всех моделях добавить:

    protected $bacula_acl; // bacula acl


    public function __construct...
        $this->bacula_acl = new MyClass_BaculaAcl();

    
    public function aclFetchAll($order) {
        $res = $this->fetchAll(null, $order)
                    ->toArray();
        // do Bacula ACLs
        return $this->bacula_acl->doBaculaAcl($res, 'name', 'pool ???');
    }    

-------------------------------------------------------------------------------------------------------
в контроллерах (где получают данные от моделей)  заменить вызовы например :
    $pools->fetchAll(...)
на
    $pools->aclFetchAll(...)

-------------------------------------------------------------------------------------------------------

Таблицы *acl
- поле name — это regexp.
- Кроме того, если в поле name есть строка _LOGIN_ то она заменяется на login юзера.
- если нет ни одного ACL правила, то юзер не имеет никаких прав.
- правила применяются в порядке order

Пример проверки ACL:

$field = 'name';
foreach($this->view->storages as $storage) {
    echo $storage->{$field}, '<br>';
}

-------------------------------------------------------------------------------------------------------

- в каталоге install создать подкаталоги для разных СУБД, перенести скрипты
- unit тесты
  http://anton.shevchuk.name/php/unit-tests-zend-framework-application/
  http://efreedom.com/Question/1-3411110/Zend-Test-PHPUnit-ControllerTestCase-Zend-Layout-Unable-Find-Layout-Plugin-Running-Tests

- заполнить остальные поля табл webacula_users
- реализация восстановления пароля
- все таблицы из БД webacula разместить в БД bacula (с префиксом webacula_*)
- в табл webacula_dt_resources добавить доступ в меню адмики
- убрать отладочный код в SQL скриптах install/
- пароли в SQL скриптах install/
- в логин форм увеличить sleep(7);  // TODO
- создать SQL индексы, если нужно
- unit тесты для других СУБД
- локализация отображаемых даты/времени с помощью Zend_Filter см. раздел "Standard Filter Classes --> Localization for date and time"
- заменить wterminal на что-то более вменяемое с подсказками
- перевод на др языки

