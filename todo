
*** Реализация : CommandACL

Необходим общий для Bacula Director и Webacula каталог.
В конфиге bacula-dir.conf:
@|"sh -c 'for f in /var/www/webacula/user-console.d/*-bconsole.conf ; do echo @${f} ; done'"
Там же создать запрещающий .htaccess
Дополнительное поле в таблице webacula_users - пароль к Director для bconsole (НЕ может совпадать с паролем на логин юзера)

Webacula тестирует доступность /var/www/webacula/user-console.d/ на запись.
При изменениях настроек роли (в админке) Webacula создает в каталоге "user-console.d"  файл с конфигурацией 
    <имя роли>-bconsole.conf
для применения в Bacula Director для каждой роли, зарегистрированной в Webacula.

Причем role-bconsole.conf для каждой роли создается на основе данных по всем Bacula ACLs, хранящимся в БД Webacula.

После создания файл role-bconsole.conf тестируется с помощью 
    /sbin/bacula-dir -t -c bacula-dir-fake.conf
    где bacula-dir-fake.conf - типовой конфиг с подключенным вновь созданным role-bconsole.conf
    
После проверки role-bconsole.conf в Bacula Director посылается команда "reload" для вступления изменений в действие.  

При запуске любой команды Webacula создает во _временном_ каталоге (еще один каталог) xxx-bconsole.conf
    где "xxx" - имя роли. 
Далее запускает для тестирования конфига 
    bconsole -t xxx-bconsole.conf
и если всё - ок, реально запускаем    
    bconsole -c xxx-bconsole.conf
и пусть Bacula сама применяет все свои ACLs.
После получения вывода от директора - удалить userlogin-bconsole.conf из временного каталога.

При этом Webacula выступает в роли Web-interfece конфигуратора для Bacula. 
Пока - с ограниченными (только Console resource) возможностями.






-------------------------------------------------------------------------------------------------------
Текущее состояние :

  * ClientACL
+  * StorageACL
+  * PoolACL
  * FileSetACL
  * WhereACL
  * ScheduleACL not used in Webacula, not implemented
  * CatalogACL  not used in Webacula, not implemented
    
-------------------------------------------------------------------------------------------------------

везде в скриптах вида, заменить обращения к объектам на массивы, т.к. возвращаться будет массив

-------------------------------------------------------------------------------------------------------
во всех моделях добавить:

    protected $bacula_acl; // bacula acl


    public function __construct...
        $this->bacula_acl = new MyClass_BaculaAcl();

    
    public function aclFetchAll($order) {
        $res = $this->fetchAll(null, $order)
                    ->toArray();
        // do Bacula ACLs
        return $this->bacula_acl->doBaculaAcl($res, 'name', 'pool ???');
    }    

-------------------------------------------------------------------------------------------------------
в контроллерах (где получают данные от моделей)  заменить вызовы например :
    $pools->fetchAll(...)
на
    $pools->aclFetchAll(...)

-------------------------------------------------------------------------------------------------------

Таблицы *acl
- поле name — это regexp.
- Кроме того, если в поле name есть строка _LOGIN_ то она заменяется на login юзера.
- если нет ни одного ACL правила, то юзер не имеет никаких прав.
- правила применяются в порядке order

Пример проверки ACL:

$field = 'name';
foreach($this->view->storages as $storage) {
    echo $storage->{$field}, '<br>';
}

-------------------------------------------------------------------------------------------------------

- unit тесты
  http://anton.shevchuk.name/php/unit-tests-zend-framework-application/
  http://efreedom.com/Question/1-3411110/Zend-Test-PHPUnit-ControllerTestCase-Zend-Layout-Unable-Find-Layout-Plugin-Running-Tests

- заполнить остальные поля табл webacula_users
- реализация восстановления пароля
- все таблицы из БД webacula разместить в БД bacula (с префиксом webacula_*)
- в табл webacula_dt_resources добавить доступ в меню адмики
- убрать отладочный код в SQL скриптах install/
- пароли в SQL скриптах install/
- в логин форм увеличить sleep(7);  // TODO
- создать SQL индексы, если нужно
- unit тесты для других СУБД
- локализация отображаемых даты/времени с помощью Zend_Filter см. раздел "Standard Filter Classes --> Localization for date and time"
- заменить wterminal на что-то более вменяемое с подсказками
- перевод на др языки

